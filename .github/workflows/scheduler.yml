import type { VercelRequest, VercelResponse } from '@vercel/node';
import { createClient } from '@supabase/supabase-js';

const supabaseUrl = process.env.VITE_SUPABASE_URL!;
const supabaseKey = process.env.VITE_SUPABASE_ANON_KEY!;
const supabase = createClient(supabaseUrl, supabaseKey);
const BOT_TOKEN = process.env.TELEGRAM_BOT_TOKEN;

export default async function handler(req: VercelRequest, res: VercelResponse) {
  // 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
  const authHeader = req.headers.authorization;
  if (authHeader !== `Bearer ${process.env.CRON_SECRET}`) {
    return res.status(401).json({ error: 'Unauthorized' });
  }

  try {
    const now = new Date();
    
    // 2. –£–ú–ù–û–ï –û–ö–†–£–ì–õ–ï–ù–ò–ï –í–†–ï–ú–ï–ù–ò
    // GitHub –∑–∞–ø—É—Å–∫–∞–µ—Ç —Å–∫—Ä–∏–ø—Ç —Ä–∞–∑ –≤ 10 –º–∏–Ω—É—Ç (00, 10, 20...).
    // –î–∞–∂–µ –µ—Å–ª–∏ —Å–∫—Ä–∏–ø—Ç –∑–∞–ø—É—Å—Ç–∏—Ç—Å—è –≤ 14:03, –º—ã –æ–∫—Ä—É–≥–ª–∏–º —ç—Ç–æ –¥–æ 14:00.
    const roundedMinutes = Math.floor(now.getUTCMinutes() / 10) * 10;
    
    // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º —á–∞—Å—ã –∏ –º–∏–Ω—É—Ç—ã (UTC)
    const hours = String(now.getUTCHours()).padStart(2, '0');
    const minutes = String(roundedMinutes).padStart(2, '0');
    const checkTimeUTC = `${hours}:${minutes}`;

    // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –¥–ª—è MSK (+3 —á–∞—Å–∞)
    const mskHourNum = (now.getUTCHours() + 3) % 24;
    const mskHours = String(mskHourNum).padStart(2, '0');
    const checkTimeMSK = `${mskHours}:${minutes}`;

    console.log(`‚è∞ CRON EXECUTION (Round to 10 min)`);
    console.log(`Searching for habits set at: ${checkTimeUTC} (UTC) OR ${checkTimeMSK} (MSK)`);

    // 3. –ü–æ–∏—Å–∫ –≤ –±–∞–∑–µ
    const { data: habits, error } = await supabase
      .from('habits')
      .select('*, users(telegram_id)')
      .in('reminder_time', [checkTimeUTC, checkTimeMSK])
      .eq('is_archived', false);

    if (error) throw error;

    console.log(`üîé Found ${habits?.length || 0} habits.`);

    // 4. –û—Ç–ø—Ä–∞–≤–∫–∞
    const results = [];
    if (habits && habits.length > 0) {
      for (const habit of habits) {
        // @ts-ignore
        const telegramId = habit.users?.telegram_id;
        if (!telegramId) continue;

        const text = `üîî **–ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ**\n–ü–æ—Ä–∞: **${habit.title}**!`;
        
        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –±–µ–∑ –ø—Ä–æ–≤–µ—Ä–∫–∏ –æ—Ç–≤–µ—Ç–∞, —á—Ç–æ–±—ã –Ω–µ —Ç–æ—Ä–º–æ–∑–∏—Ç—å —Ü–∏–∫–ª
        const send = await fetch(`https://api.telegram.org/bot${BOT_TOKEN}/sendMessage`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            chat_id: telegramId,
            text: text,
            parse_mode: 'Markdown',
            reply_markup: {
              inline_keyboard: [[{ text: "‚úÖ –ì–æ—Ç–æ–≤–æ", callback_data: `done_${habit.id}` }]]
            }
          })
        });
        results.push(send.status);
      }
    }

    return res.status(200).json({ 
      ok: true, 
      checked: [checkTimeUTC, checkTimeMSK],
      found: habits?.length,
      sent: results.length
    });

  } catch (error: any) {
    console.error('CRON ERROR:', error);
    return res.status(500).json({ error: error.message });
  }
}
